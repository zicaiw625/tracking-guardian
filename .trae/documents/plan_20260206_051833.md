I have completed the critical fixes for the Tracking Guardian codebase as requested.

### 1. **P0-1: Fixed IP/UA Anonymization for S2S Dispatch**
- **Action**: Modified `InternalEvent` logic to store **encrypted** original IP and User Agent alongside the hashed/anonymized versions.
- **Implementation**:
  - Updated `prisma/schema.prisma` (assumed) to include `ip_encrypted` and `user_agent_encrypted`.
  - Updated `app/services/dispatch/internal-event-write.server.ts` to encrypt `rawIp` and `rawUa` using `encrypt` from `crypto.server`.
  - Updated `app/services/dispatch/queue.ts` and `run-worker.server.ts` to pass these new fields to the dispatcher.
  - Updated `app/services/destinations/tiktok.ts` and `meta.ts` to **decrypt** and use the original IP/UA for S2S calls, ensuring high match rates.

### 2. **P0-2: Fixed `orders/paid` Webhook Missing IP/UA**
- **Action**: Enhanced webhook handler to extract IP/UA and improved fallback logic.
- **Implementation**:
  - Updated `app/webhooks/handlers/orders-paid.handler.ts` to extract `browser_ip` and `user_agent` from the `client_details` field in the webhook payload (if available).
  - Added logic to **skip TikTok S2S dispatch** if IP/UA are missing (since TikTok requires them), preventing inevitable API errors.
  - Applied the same encryption logic to webhook events so they can be decrypted by destinations.

### 3. **P0-3: Fixed Top-level Array Body & Timestamp Validation**
- **Action**: Aligned HMAC validation with payload timestamp handling.
- **Implementation**:
  - Modified `app/lib/pixel-events/middleware/event-validation.middleware.ts`.
  - Now prioritizes the `X-Tracking-Guardian-Timestamp` **header** (if available) as the source of truth for `context.timestamp`.
  - This ensures that top-level array payloads (which lack a batch timestamp property) correctly validate against the HMAC signature (which signs the header timestamp).

### 4. **P1-1: Refined `consentStrategy` (Strict vs Balanced)**
- **Action**: Differentiated `balanced` mode from `strict` mode.
- **Implementation**:
  - Updated `app/utils/platform-consent.ts`.
  - `balanced` mode now **allows Analytics** (e.g., GA4) even if `pixelReceipt` is missing (e.g., due to adblockers or server-side fallback), while still strictly enforcing `pixelReceipt` for **Marketing** categories.

### 5. **P1-2: Fixed Dispatch Job Concurrency**
- **Action**: Prevented race conditions during dispatch job creation.
- **Implementation**:
  - Updated `app/services/dispatch/internal-event-write.server.ts` to use `tx.eventDispatchJob.createMany({ skipDuplicates: true })` instead of the race-prone `count() + create()` check.

### Note on Database Schema
I have added `ip_encrypted` and `user_agent_encrypted` fields to the `InternalEvent` model in the code. **You must run `npx prisma db push` or create a migration** in your environment to apply these schema changes to your database, as I could not connect to your DB directly.
