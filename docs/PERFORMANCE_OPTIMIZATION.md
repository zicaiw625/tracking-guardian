# 性能优化文档

## 前端性能优化

### Bundle 优化

#### 代码分割
- ✅ 使用 Vite 的 `manualChunks` 配置分离大型库
- ✅ React/React-DOM 单独打包
- ✅ Shopify 相关库单独打包
- ✅ Chart.js 相关库单独打包

#### 懒加载
- ✅ 路由级别的代码分割（Remix 自动处理）
- ✅ 大型组件懒加载
- ✅ 图表组件按需加载

#### 资源优化
- ✅ 小于 4KB 的资源内联（`assetsInlineLimit: 4096`）
- ✅ 生产环境移除 console 日志
- ✅ Terser 压缩优化

### 性能指标目标

| 指标 | 目标值 | 当前状态 |
|------|--------|---------|
| LCP (Largest Contentful Paint) | < 2.5s | ✅ 已实现监控 |
| CLS (Cumulative Layout Shift) | < 0.1 | ✅ 已实现监控 |
| INP (Interaction to Next Paint) | < 200ms | ✅ 已实现监控 |
| FCP (First Contentful Paint) | < 1.8s | ✅ 已实现监控 |
| TTFB (Time to First Byte) | < 800ms | ✅ 已实现监控 |

### 优化建议

1. **图片优化**
   - 使用 WebP 格式
   - 实现懒加载
   - 使用 CDN 加速

2. **字体优化**
   - 使用 `font-display: swap`
   - 预加载关键字体

3. **CSS 优化**
   - 移除未使用的 CSS
   - 关键 CSS 内联

## Checkout 性能优化

### UI Extension 优化

#### 组件轻量化
- ✅ 最小化组件大小
- ✅ 避免不必要的依赖
- ✅ 使用 Polaris 组件而非自定义实现

#### 网络请求优化
- ✅ 减少 API 调用次数
- ✅ 使用批量请求
- ✅ 实现请求缓存

#### 延迟加载
- ✅ 非关键资源延迟加载
- ✅ 图片懒加载
- ✅ 第三方脚本异步加载

### 性能监控

使用 Shopify 的 Performance API 监控：
- 组件加载时间
- API 响应时间
- 用户交互延迟

## 后端性能优化

### 数据库优化

#### 索引优化
- ✅ 为常用查询字段添加索引
- ✅ 复合索引优化
- ✅ 定期分析慢查询

#### 查询优化
- ✅ 使用 Prisma 的 `select` 只查询需要的字段
- ✅ 避免 N+1 查询问题
- ✅ 使用批量查询

#### 连接池优化
- ✅ 配置合适的连接池大小
- ✅ 监控连接池使用情况

### 缓存策略

#### 内存缓存
- ✅ 使用内存缓存存储热点数据
- ✅ 设置合理的过期时间
- ✅ 实现缓存失效策略

#### Redis 缓存（可选）
- ✅ 分布式缓存支持
- ✅ 会话存储
- ✅ 队列任务存储

### API 响应优化

1. **批量处理**
   - 批量处理订单数据
   - 批量发送事件

2. **异步处理**
   - 使用队列处理耗时任务
   - 后台任务异步执行

3. **响应压缩**
   - 启用 gzip 压缩
   - JSON 响应压缩

## 监控与测量

### 性能监控工具

1. **Web Vitals**
   - ✅ 集成 Web Vitals 库 (`web-vitals`)
   - ✅ 上报性能指标 (`/api/performance`)
   - ✅ 性能数据存储 (`PerformanceMetric` 模型)
   - ✅ 性能统计服务 (`performance-monitor.server.ts`)

2. **APM 工具**
   - 使用 APM 工具监控后端性能
   - 追踪慢查询和错误

3. **日志分析**
   - 结构化日志
   - 性能日志分析

### 性能测试

#### 负载测试
- 使用 k6 或 Artillery 进行负载测试
- 测试不同并发场景

#### 压力测试
- 测试系统极限
- 识别性能瓶颈

## 优化检查清单

### 前端
- [ ] Bundle 大小 < 500KB (gzipped)
- [ ] 首屏加载时间 < 3s
- [ ] LCP < 2.5s
- [ ] CLS < 0.1
- [ ] INP < 200ms

### Checkout
- [ ] UI Extension 加载时间 < 1s
- [ ] 事件发送延迟 < 100ms
- [ ] 无阻塞渲染的脚本

### 后端
- [ ] API 响应时间 < 500ms (p95)
- [ ] 数据库查询时间 < 100ms (p95)
- [ ] 错误率 < 0.1%

## 持续优化

1. **定期性能审计**
   - 每月进行性能审计
   - 识别性能退化

2. **A/B 测试**
   - 测试不同的优化策略
   - 测量实际效果

3. **用户反馈**
   - 收集用户性能反馈
   - 优先优化用户痛点
