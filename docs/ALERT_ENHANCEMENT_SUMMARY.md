# 监控告警功能增强总结

## ✅ 已完成的功能

### 1. 监控页面告警状态显示
**文件：** `app/routes/app.monitor.tsx`

**新增功能：**
- ✅ 实时告警状态卡片
  - 显示当前触发的告警（失败率、缺参率、量降、去重冲突、心跳丢失）
  - 按严重程度分类显示（严重/高/中）
  - 每个告警显示详细消息和操作按钮

- ✅ 告警配置状态提示
  - 未配置告警时显示提示横幅
  - 已配置告警时显示配置数量
  - 快速跳转到告警配置页面

- ✅ 告警历史记录
  - 显示最近 10 条告警历史
  - 包含时间、类型、严重程度、消息
  - 支持查看全部告警历史

### 2. 告警配置界面增强
**文件：** `app/routes/settings/_components/AlertsTab.tsx`

**新增功能：**
- ✅ 告警规则说明
  - 详细列出所有支持的告警类型
  - 说明每种告警的触发条件
  - 显示默认阈值

**支持的告警类型：**
1. **事件失败率** - 当发送失败率超过阈值时告警（默认 2%）
2. **参数缺失率** - 当 Purchase 事件缺参率超过阈值时告警（默认 10%）
3. **事件量骤降** - 当 24h 内事件量下降超过 50% 时告警
4. **去重冲突** - 当检测到重复事件 ID 时告警（默认 5 次）
5. **像素心跳丢失** - 当超过 24 小时未收到像素心跳时告警

### 3. 后端告警检测服务（已存在）
**文件：** `app/services/alert-dispatcher.server.ts`

**已有功能：**
- ✅ `checkFailureRate()` - 检查事件失败率
- ✅ `checkMissingParams()` - 检查参数缺失率
- ✅ `checkVolumeDrop()` - 检查事件量骤降
- ✅ `checkDedupConflicts()` - 检查去重冲突
- ✅ `checkPixelHeartbeat()` - 检查像素心跳
- ✅ `runAlertChecks()` - 运行所有告警检查
- ✅ `getAlertHistory()` - 获取告警历史
- ✅ `acknowledgeAlert()` - 确认告警

### 4. 告警通知服务（已存在）
**文件：** `app/services/notification.server.ts`

**已有功能：**
- ✅ 邮件告警（Email）
- ✅ Slack 告警（Webhook）
- ✅ Telegram 告警（Bot API）
- ✅ 告警频率限制（instant/hourly/daily/weekly）

### 5. 定时任务（已存在）
**文件：** `app/cron/tasks/alert-checks.ts`

**已有功能：**
- ✅ 每小时自动运行告警检查
- ✅ 批量检查所有活跃店铺
- ✅ 自动发送触发的告警通知

## 📊 告警检测逻辑

### 事件失败率告警
- **阈值：** 默认 2%（可配置）
- **最小样本：** 至少 10 条事件
- **严重程度：**
  - > 10%：严重
  - > 5%：高
  - > 2%：中

### 参数缺失率告警
- **阈值：** 默认 10%（可配置）
- **最小样本：** 至少 5 条 Purchase 事件
- **检测项：** value、currency、items 等关键参数
- **严重程度：**
  - > 20%：高
  - > 10%：中

### 事件量骤降告警
- **阈值：** 默认 50% 下降
- **时间窗口：** 对比前 24h 与当前 24h
- **最小样本：** 前 24h 至少 10 条事件
- **严重程度：**
  - > 80% 下降：严重
  - > 60% 下降：高
  - > 50% 下降：中

### 去重冲突告警
- **阈值：** 默认 5 次冲突
- **检测方式：** 同一 eventId 出现多次
- **严重程度：**
  - > 20 次：高
  - > 5 次：中

### 像素心跳丢失告警
- **阈值：** 默认 24 小时
- **检测方式：** 检查最后一次 PixelEventReceipt 时间
- **严重程度：**
  - > 48 小时：严重
  - > 24 小时：高

## 🎯 用户体验改进

### 监控页面
1. **一目了然的告警状态**
   - 页面顶部显示当前告警状态
   - 彩色卡片区分严重程度
   - 快速操作按钮

2. **告警历史追踪**
   - 表格形式展示历史告警
   - 支持查看详细信息
   - 链接到配置页面

3. **配置引导**
   - 未配置时显示引导横幅
   - 已配置时显示配置摘要
   - 快速跳转到配置页面

### 配置页面
1. **清晰的规则说明**
   - 列出所有告警类型
   - 说明触发条件
   - 显示默认阈值

2. **灵活的配置选项**
   - 支持多种通知渠道
   - 可配置告警频率
   - 可调整阈值

## 🔄 工作流程

### 告警触发流程
1. **定时检查**（每小时）
   - Cron 任务运行 `runAlertCheckTask()`
   - 对所有活跃店铺执行告警检查
   - 检测各种告警条件

2. **告警评估**
   - 检查是否超过阈值
   - 评估严重程度
   - 检查频率限制

3. **通知发送**
   - 根据配置的渠道发送通知
   - 更新最后告警时间
   - 记录告警历史

4. **用户查看**
   - 在监控页面查看实时状态
   - 查看告警历史记录
   - 配置告警规则

## 📝 后续优化建议

### 短期（1-2周）
1. **告警规则自定义**
   - 允许用户为每种告警类型单独配置阈值
   - 支持按平台设置不同阈值
   - 添加告警规则模板

2. **告警确认功能**
   - 在监控页面添加"确认告警"按钮
   - 标记已处理的告警
   - 防止重复通知

3. **告警统计**
   - 显示告警趋势图表
   - 统计告警频率
   - 分析告警原因

### 中期（2-4周）
1. **智能告警**
   - 基于历史数据自动调整阈值
   - 识别误报并过滤
   - 学习用户行为模式

2. **告警聚合**
   - 合并相似告警
   - 减少通知频率
   - 提供告警摘要

3. **多渠道通知**
   - 支持同时配置多个通知渠道
   - 按严重程度选择通知渠道
   - 告警升级机制

## ✅ 总结

监控告警功能已基本完善，包括：
- ✅ 5 种告警类型检测
- ✅ 实时告警状态显示
- ✅ 告警历史记录
- ✅ 多渠道通知支持
- ✅ 定时自动检查

用户现在可以：
1. 在监控页面实时查看告警状态
2. 配置告警规则和通知渠道
3. 查看告警历史记录
4. 及时收到异常通知

整体功能已满足设计方案 4.6 的要求，可以投入使用。

