generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
}

model Shop {
  id                      String              @id
  shopDomain              String              @unique
  accessToken             String?
  email                   String?
  name                    String?
  plan                    String              @default("free")
  monthlyOrderLimit       Int                 @default(100)
  installedAt             DateTime            @default(now())
  uninstalledAt           DateTime?
  isActive                Boolean             @default(true)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime
  dataRetentionDays       Int                 @default(90)
  ingestionSecret         String?
  weakConsentMode         Boolean             @default(false)
  consentStrategy         String              @default("strict")
  previousIngestionSecret String?
  previousSecretExpiry    DateTime?
  webPixelId              String?
  storefrontDomains       String[]
  primaryDomain           String?
  shopTier                String?
  typOspPagesEnabled      Boolean?
  typOspUpdatedAt         DateTime?
  typOspLastCheckedAt     DateTime?
  typOspDetectedAt        DateTime?
  typOspStatusReason      String?
  settings                Json?
  AuditAsset              AuditAsset[]
  pixelConfigs            PixelConfig[]
  PixelEventReceipt       PixelEventReceipt[]
  ScanReports             ScanReport[]
  VerificationRun         VerificationRun[]
  EventLog                EventLog[]
  DeliveryAttempt         DeliveryAttempt[]
  SurveyResponse          SurveyResponse[]
  ExtensionError          ExtensionError[]
}

model AuditAsset {
  id                   String    @id
  shopId               String
  sourceType           String    @default("api_scan")
  category             String    @default("other")
  platform             String?
  fingerprint          String?
  displayName          String?
  riskLevel            String    @default("medium")
  suggestedMigration   String    @default("web_pixel")
  migrationStatus      String    @default("pending")
  migratedAt           DateTime?
  details              Json?
  scanReportId         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime
  priority             Int?
  estimatedTimeMinutes Int?
  dependencies         Json?
  rawSnippetEncrypted  String?
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, fingerprint])
  @@index([category])
  @@index([migrationStatus])
  @@index([platform])
  @@index([riskLevel])
  @@index([shopId, category, riskLevel])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, migrationStatus])
  @@index([shopId, riskLevel])
}

model ScanReport {
  id                  String    @id
  shopId              String
  scriptTags          Json?
  checkoutConfig      Json?
  riskItems           Json?
  riskScore           Int       @default(0)
  identifiedPlatforms Json?
  status              String    @default("pending")
  errorMessage        String?
  shareTokenHash      String?
  shareTokenExpiresAt DateTime?
  createdAt           DateTime  @default(now())
  completedAt         DateTime?
  Shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([status])
}

model PixelConfig {
  id                   String    @id
  shopId               String
  platform             String
  platformId           String?
  clientSideEnabled    Boolean   @default(true)
  serverSideEnabled    Boolean   @default(false)
  eventMappings        Json?
  migrationStatus      String    @default("not_started")
  migratedAt           DateTime?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime
  clientConfig         Json?
  credentialsEncrypted String?
  credentials_legacy   Json?
  configVersion        Int       @default(1)
  environment          String    @default("live")
  previousConfig       Json?
  rollbackAllowed      Boolean   @default(true)
  displayName          String?
  priority             Int?      @default(0)
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, platform, environment, platformId])
  @@index([environment])
  @@index([platform])
  @@index([priority])
  @@index([shopId])
  @@index([shopId, platform])
}

model PixelEventReceipt {
  id                String           @id
  shopId            String
  eventId           String
  eventType         String
  pixelTimestamp    DateTime
  verificationRunId String?
  originHost        String?
  payloadJson       Json?
  orderKey          String?
  createdAt         DateTime         @default(now())
  Shop              Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  VerificationRun   VerificationRun? @relation(fields: [verificationRunId], references: [id], onDelete: SetNull)

  @@unique([shopId, eventId, eventType])
  @@index([shopId])
  @@index([shopId, pixelTimestamp])
  @@index([verificationRunId])
  @@index([eventType])
  @@index([shopId, eventType, pixelTimestamp])
  @@index([orderKey])
  @@index([eventId])
}

model VerificationRun {
  id                  String              @id
  shopId              String
  runName             String              @default("验收测试")
  runType             String              @default("quick")
  status              String              @default("pending")
  platforms           String[]
  summaryJson         Json?
  eventsJson          Json?
  reportUrl           String?
  publicId            String?             @unique
  publicTokenHash     String?
  shareTokenExpiresAt DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime            @default(now())
  Shop                Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  PixelEventReceipt   PixelEventReceipt[]

  @@index([createdAt])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, status, createdAt])
  @@index([shopId, status])
  @@index([status])
  @@index([publicId])
}

model EventLog {
  id                  String            @id
  shopId              String
  source              String            @default("web_pixel")
  eventName           String
  eventId             String
  occurredAt          DateTime
  shopifyContextJson  Json?
  normalizedEventJson Json
  createdAt           DateTime          @default(now())
  Shop                Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  DeliveryAttempt     DeliveryAttempt[]

  @@unique([shopId, eventId])
  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([shopId, eventName, createdAt])
  @@index([eventId])
  @@index([occurredAt])
}

model DeliveryAttempt {
  id                  String   @id
  eventLogId          String
  shopId              String
  receiptId           String?
  destinationType     String
  environment         String   @default("live")
  platform            String?
  requestPayloadJson  Json
  status              String   @default("pending")
  httpStatus          Int?
  ok                  Boolean  @default(false)
  errorCode           String?
  errorDetail         String?
  responseBodySnippet String?
  latencyMs           Int?
  verificationRunId   String?
  createdAt           DateTime @default(now())
  Shop                Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  EventLog            EventLog @relation(fields: [eventLogId], references: [id], onDelete: Cascade)

  @@unique([shopId, eventLogId, destinationType, environment])
  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([shopId, destinationType, createdAt])
  @@index([shopId, status, createdAt])
  @@index([eventLogId])
  @@index([receiptId])
  @@index([platform])
  @@index([verificationRunId])
}

model SurveyResponse {
  id            String   @id
  shopId        String
  orderId       String
  orderNumber   String?
  rating        Int?
  feedback      String?
  source        String?
  customAnswers Json?
  createdAt     DateTime @default(now())
  Shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([orderId])
  @@index([shopId, orderId])
  @@index([shopId, createdAt])
}

model ExtensionError {
  id        String   @id
  shopId    String
  shopDomain String
  extension String
  endpoint  String
  error     String
  stack     String?
  target    String?
  orderId   String?
  createdAt DateTime @default(now())
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([extension])
  @@index([endpoint])
  @@index([shopId, extension, createdAt])
}
