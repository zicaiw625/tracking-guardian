generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken  String?
  refreshTokenExpires DateTime?
  createdAt     DateTime  @default(now())

  @@index([shop])
}

model Shop {
  id                      String                 @id
  shopDomain              String                 @unique
  accessTokenEncrypted    String?
  email                   String?
  name                    String?
  plan                    String                 @default("free")
  monthlyOrderLimit       Int                    @default(100)
  entitledUntil           DateTime?
  installedAt             DateTime               @default(now())
  uninstalledAt           DateTime?
  isActive                Boolean                @default(true)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  dataRetentionDays       Int                    @default(90)
  ingestionSecret         String?
  weakConsentMode         Boolean                @default(false)
  consentStrategy         String                 @default("strict")
  previousIngestionSecret String?
  previousSecretExpiry    DateTime?
  webPixelId              String?
  storefrontDomains       String[]
  primaryDomain           String?
  shopTier                String?
  shopTierLastCheckedAt   DateTime?
  typOspPagesEnabled      Boolean?
  typOspUpdatedAt         DateTime?
  typOspLastCheckedAt     DateTime?
  typOspDetectedAt        DateTime?
  typOspStatusReason      String?
  settings                Json?
  AuditAsset              AuditAsset[]
  pixelConfigs            PixelConfig[]
  PixelEventReceipt       PixelEventReceipt[]
  ScanReports             ScanReport[]
  VerificationRun         VerificationRun[]
  EventLog                EventLog[]
  DeliveryAttempt         DeliveryAttempt[]
  SurveyResponse          SurveyResponse[]
  ExtensionError          ExtensionError[]
  MonthlyUsage            MonthlyUsage[]
  MigrationDraft          MigrationDraft?
  ShopifyOrderSnapshot    ShopifyOrderSnapshot[]
  RefundSnapshot          RefundSnapshot[]
  ConversionJob           ConversionJob[]
  ConversionLog           ConversionLog[]
  EventNonce              EventNonce[]
  AuditLog                AuditLog[]
  ReconciliationReport    ReconciliationReport[]
  AlertEvent              AlertEvent[]
  DailyAggregatedMetrics  DailyAggregatedMetrics[]
}

model AuditAsset {
  id                   String    @id
  shopId               String
  sourceType           String    @default("api_scan")
  category             String    @default("other")
  platform             String?
  fingerprint          String?
  displayName          String?
  riskLevel            String    @default("medium")
  suggestedMigration   String    @default("web_pixel")
  migrationStatus      String    @default("pending")
  migratedAt           DateTime?
  details              Json?
  scanReportId         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  priority             Int?
  estimatedTimeMinutes Int?
  dependencies         Json?
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, fingerprint])
  @@index([category])
  @@index([migrationStatus])
  @@index([platform])
  @@index([riskLevel])
  @@index([shopId, category, riskLevel])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, migrationStatus])
  @@index([shopId, riskLevel])
}

model ScanReport {
  id                  String    @id
  shopId              String
  scriptTags          Json?
  checkoutConfig      Json?
  riskItems           Json?
  riskScore           Int       @default(0)
  identifiedPlatforms Json?
  status              String    @default("pending")
  errorMessage        String?
  shareTokenHash      String?
  shareTokenExpiresAt DateTime?
  createdAt           DateTime  @default(now())
  completedAt         DateTime?
  Shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([status])
}

model PixelConfig {
  id                   String    @id
  shopId               String
  platform             String
  platformId           String?
  clientSideEnabled    Boolean   @default(true)
  serverSideEnabled    Boolean   @default(false)
  eventMappings        Json?
  migrationStatus      String    @default("not_started")
  migratedAt           DateTime?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  clientConfig         Json?
  credentialsEncrypted String?
  credentials_legacy   Json?
  configVersion        Int       @default(1)
  environment          String    @default("live")
  previousConfig       Json?
  rollbackAllowed      Boolean   @default(true)
  displayName          String?
  priority             Int?      @default(0)
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, platform, environment, platformId])
  @@index([environment])
  @@index([platform])
  @@index([priority])
  @@index([shopId])
  @@index([shopId, platform])
}

model PixelEventReceipt {
  id                String           @id
  shopId            String
  eventId           String
  eventType         String
  pixelTimestamp    DateTime
  verificationRunId String?
  originHost        String?
  payloadJson       Json?
  checkoutFingerprint String?
  orderKey          String?
  altOrderKey       String?
  createdAt         DateTime         @default(now())
  Shop              Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  VerificationRun   VerificationRun? @relation(fields: [verificationRunId], references: [id], onDelete: SetNull)

  @@unique([shopId, eventId, eventType])
  @@index([shopId])
  @@index([shopId, pixelTimestamp])
  @@index([verificationRunId])
  @@index([eventType])
  @@index([shopId, eventType, pixelTimestamp])
  @@index([orderKey])
  @@index([altOrderKey])
  @@index([eventId])
}

model VerificationRun {
  id                  String              @id
  shopId              String
  runName             String              @default("验收测试")
  runType             String              @default("quick")
  status              String              @default("pending")
  platforms           String[]
  summaryJson         Json?
  eventsJson          Json?
  reportUrl           String?
  publicId            String?             @unique
  publicTokenHash     String?
  shareTokenExpiresAt DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime            @default(now())
  Shop                Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  PixelEventReceipt   PixelEventReceipt[]

  @@index([createdAt])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, status, createdAt])
  @@index([shopId, status])
  @@index([status])
  @@index([publicId])
}

model EventLog {
  id                  String            @id
  shopId              String
  source              String            @default("web_pixel")
  eventName           String
  eventId             String
  occurredAt          DateTime
  shopifyContextJson  Json?
  normalizedEventJson Json
  createdAt           DateTime          @default(now())
  Shop                Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  DeliveryAttempt     DeliveryAttempt[]

  @@unique([shopId, eventId])
  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([shopId, eventName, createdAt])
  @@index([eventId])
  @@index([occurredAt])
}

model DeliveryAttempt {
  id                  String   @id
  eventLogId          String
  shopId              String
  receiptId           String?
  destinationType     String
  environment         String   @default("live")
  platform            String?
  requestPayloadJson  Json
  status              String   @default("pending")
  httpStatus          Int?
  ok                  Boolean  @default(false)
  errorCode           String?
  errorDetail         String?
  responseBodySnippet String?
  latencyMs           Int?
  verificationRunId   String?
  createdAt           DateTime @default(now())
  Shop                Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  EventLog            EventLog @relation(fields: [eventLogId], references: [id], onDelete: Cascade)

  @@unique([shopId, eventLogId, destinationType, environment])
  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([shopId, destinationType, createdAt])
  @@index([shopId, status, createdAt])
  @@index([eventLogId])
  @@index([receiptId])
  @@index([platform])
  @@index([verificationRunId])
}

model SurveyResponse {
  id            String   @id
  shopId        String
  orderId       String
  orderNumber   String?
  rating        Int?
  feedback      String?
  source        String?
  customAnswers Json?
  createdAt     DateTime @default(now())
  Shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([orderId])
  @@index([shopId, orderId])
  @@index([shopId, createdAt])
}

model ExtensionError {
  id          String   @id
  shopId      String
  shopDomain  String
  extension   String
  endpoint    String
  error       String
  stack       String?
  target      String?
  orderIdHash String?
  createdAt   DateTime @default(now())
  Shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([extension])
  @@index([endpoint])
  @@index([shopId, extension, createdAt])
}

model WebhookLog {
  id          String    @id
  shopDomain  String
  webhookId   String
  topic       String
  status      String    @default("processing")
  orderId     String?
  receivedAt  DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@unique([shopDomain, webhookId, topic])
  @@index([shopDomain])
  @@index([receivedAt])
  @@index([receivedAt, status])
}

model MonthlyUsage {
  id        String   @id
  shopId    String
  yearMonth String
  sentCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, yearMonth])
  @@index([shopId])
  @@index([yearMonth])
}

model MigrationDraft {
  id         String   @id
  shopId     String   @unique
  step       String
  configData Json
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([shopId, updatedAt])
}

model ShopifyOrderSnapshot {
  id              String    @id
  shopId          String
  orderId         String
  orderNumber     String?
  totalValue      Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  financialStatus String?
  cancelledAt     DateTime?
  updatedAt       DateTime  @updatedAt
  createdAt       DateTime
  Shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, orderId])
  @@index([shopId, createdAt])
  @@index([shopId, orderId])
  @@index([orderId])
  @@index([cancelledAt])
}

model RefundSnapshot {
  id        String   @id
  shopId    String
  refundId  String
  orderId   String
  amount    Decimal  @db.Decimal(10, 2)
  currency  String   @default("USD")
  createdAt DateTime
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, refundId])
  @@index([shopId, createdAt])
  @@index([shopId, orderId])
  @@index([orderId])
  @@index([refundId])
}

model ConversionJob {
  id              String    @id
  shopId          String
  orderId         String
  orderNumber     String?
  orderValue      Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  capiInput       Json?
  webhookCheckoutFingerprint String?
  consentEvidence Json?
  trustMetadata   Json?
  status          String    @default("queued")
  attempts        Int       @default(0)
  maxAttempts     Int       @default(5)
  lastAttemptAt   DateTime?
  nextRetryAt     DateTime?
  errorMessage    String?
  platformResults Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  processedAt     DateTime?
  completedAt     DateTime?
  Shop            Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, orderId])
  @@index([shopId])
  @@index([status])
  @@index([status, nextRetryAt])
  @@index([createdAt])
}

model ConversionLog {
  id               String    @id
  shopId           String
  orderId          String
  orderNumber      String?
  orderValue       Decimal   @db.Decimal(10, 2)
  currency         String    @default("USD")
  eventId          String?
  platform         String
  eventType        String
  status           String    @default("pending")
  attempts         Int       @default(0)
  maxAttempts      Int       @default(5)
  lastAttemptAt    DateTime?
  nextRetryAt      DateTime?
  errorMessage     String?
  platformResponse Json?
  clientSideSent   Boolean   @default(false)
  serverSideSent   Boolean   @default(false)
  deadLetteredAt   DateTime?
  manuallyRetried  Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sentAt           DateTime?
  Shop             Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, orderId, platform, eventType])
  @@index([shopId])
  @@index([orderId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@index([shopId, createdAt])
  @@index([shopId, status])
  @@index([shopId, platform, createdAt])
  @@index([shopId, createdAt, status])
  @@index([status, nextRetryAt])
  @@index([status, deadLetteredAt])
}

model EventNonce {
  id        String   @id
  shopId    String
  nonce     String
  eventType String
  createdAt DateTime @default(now())
  expiresAt DateTime
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, nonce, eventType])
  @@index([expiresAt])
  @@index([shopId])
}

model GDPRJob {
  id           String    @id
  shopDomain   String
  jobType      String
  payload      Json
  status       String    @default("queued")
  result       Json?
  errorMessage String?
  createdAt    DateTime  @default(now())
  processedAt  DateTime?
  completedAt  DateTime?

  @@index([status])
  @@index([shopDomain])
  @@index([createdAt])
}

model AuditLog {
  id            String   @id
  shopId        String
  actorType     String
  actorId       String?
  action        String
  resourceType  String
  resourceId    String?
  previousValue Json?
  newValue      Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  Shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@index([shopId, createdAt])
}

model ReconciliationReport {
  id                  String   @id
  shopId              String
  platform            String
  reportDate          DateTime @db.Date
  shopifyOrders       Int      @default(0)
  shopifyRevenue      Decimal  @default(0) @db.Decimal(12, 2)
  platformConversions Int      @default(0)
  platformRevenue     Decimal  @default(0) @db.Decimal(12, 2)
  orderDiscrepancy    Float    @default(0)
  revenueDiscrepancy  Float    @default(0)
  status              String   @default("pending")
  alertSent           Boolean  @default(false)
  createdAt           DateTime @default(now())
  Shop                Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, platform, reportDate])
  @@index([shopId])
  @@index([platform])
  @@index([reportDate])
  @@index([shopId, reportDate])
}

model AlertEvent {
  id          String   @id @default(cuid())
  shopId      String
  alertType   String
  severity    String
  fingerprint String
  message     String
  channel     String
  payloadHash String
  sentAt      DateTime @default(now())
  ackAt       DateTime?
  createdAt   DateTime @default(now())
  Shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, fingerprint, sentAt])
  @@index([shopId, sentAt])
  @@index([shopId, alertType, sentAt])
  @@index([fingerprint])
}

model DailyAggregatedMetrics {
  id                String   @id @default(cuid())
  shopId            String
  date              DateTime @db.Date
  totalOrders       Int      @default(0)
  totalValue        Decimal  @db.Decimal(12, 2)
  successRate       Float
  platformBreakdown Json
  eventVolume       Int      @default(0)
  missingParamsRate Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@index([shopId, date])
  @@index([date])
}
