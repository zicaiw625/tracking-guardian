generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken  String?
  refreshTokenExpires DateTime?
  createdAt     DateTime  @default(now())

  @@index([shop])
}

model Shop {
  id                      String                 @id
  shopDomain              String                 @unique
  accessTokenEncrypted    String?
  email                   String?
  name                    String?
  plan                    String                 @default("free")
  monthlyOrderLimit       Int                    @default(100)
  entitledUntil           DateTime?
  installedAt             DateTime               @default(now())
  uninstalledAt           DateTime?
  isActive                Boolean                @default(true)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  dataRetentionDays       Int                    @default(90)
  ingestionSecret         String?
  weakConsentMode         Boolean                @default(false)
  consentStrategy         String                 @default("strict")
  pendingIngestionSecret  String?
  pendingSecretIssuedAt   DateTime?
  pendingSecretExpiry     DateTime?
  pendingSecretMatchCount Int                    @default(0)
  previousIngestionSecret String?
  previousSecretExpiry    DateTime?
  webPixelId              String?
  storefrontDomains       String[]
  primaryDomain           String?
  shopTier                String?
  shopTierLastCheckedAt   DateTime?
  typOspPagesEnabled      Boolean?
  typOspUpdatedAt         DateTime?
  typOspLastCheckedAt     DateTime?
  typOspDetectedAt        DateTime?
  typOspStatusReason      String?
  settings                Json?
  AuditAsset              AuditAsset[]
  pixelConfigs            PixelConfig[]
  PixelEventReceipt       PixelEventReceipt[]
  ScanReports             ScanReport[]
  VerificationRun         VerificationRun[]
  EventLog                EventLog[]
  MonthlyUsage            MonthlyUsage[]
  MigrationDraft          MigrationDraft?
  AuditLog                AuditLog[]
  AlertEvent              AlertEvent[]
  DailyAggregatedMetrics   DailyAggregatedMetrics[]
  OrderSummary             OrderSummary[]
  InternalEvent            InternalEvent[]
  BatchAuditJob            BatchAuditJob[]
  ExtensionError           ExtensionError[]
  ReportShareLink          ReportShareLink[]
}

model ExtensionError {
  id          String   @id @default(uuid())
  shopId      String
  shopDomain  String
  extension   String
  endpoint    String
  error       String
  stack       String?
  target      String?
  orderIdHash String?
  timestamp   DateTime
  createdAt   DateTime @default(now())
  Shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([shopId, timestamp])
  @@index([createdAt])
}

model OrderSummary {
  id         String   @id
  shopId     String
  orderId   String
  totalPrice Decimal  @db.Decimal(12, 2)
  currency  String
  createdAt DateTime @default(now())
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, orderId])
  @@index([shopId])
  @@index([shopId, orderId])
}

model AlertEvent {
  id          String    @id
  shopId      String
  alertType   String
  severity    String
  fingerprint String
  message     String
  channel     String
  payloadHash String
  sentAt      DateTime  @default(now())
  ackAt       DateTime?
  createdAt   DateTime  @default(now())
  Shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, fingerprint, sentAt])
  @@index([shopId, sentAt])
  @@index([shopId, alertType, sentAt])
  @@index([fingerprint])
}

model DailyAggregatedMetrics {
  id                 String   @id
  shopId             String
  date               DateTime @db.Date
  totalOrders        Int      @default(0)
  totalValue         Decimal  @db.Decimal(12, 2)
  successRate        Float
  platformBreakdown  Json
  eventVolume        Int      @default(0)
  missingParamsRate  Float
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  Shop               Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@index([shopId, date])
  @@index([date])
}

model AuditAsset {
  id                   String    @id
  shopId               String
  sourceType           String    @default("api_scan")
  category             String    @default("other")
  platform             String?
  fingerprint          String?
  displayName          String?
  riskLevel            String    @default("medium")
  suggestedMigration   String    @default("web_pixel")
  migrationStatus      String    @default("pending")
  migratedAt           DateTime?
  details              Json?
  scanReportId         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  priority             Int?
  estimatedTimeMinutes Int?
  dependencies         Json?
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, fingerprint])
  @@index([category])
  @@index([migrationStatus])
  @@index([platform])
  @@index([riskLevel])
  @@index([shopId, category, riskLevel])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, migrationStatus])
  @@index([shopId, riskLevel])
}

model ScanReport {
  id                  String    @id
  shopId              String
  scriptTags          Json?
  checkoutConfig      Json?
  riskItems           Json?
  riskScore           Int       @default(0)
  identifiedPlatforms Json?
  status              String    @default("pending")
  errorMessage        String?
  createdAt           DateTime  @default(now())
  completedAt         DateTime?
  Shop                Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([status])
}

model PixelConfig {
  id                   String    @id
  shopId               String
  platform             String
  platformId           String?
  clientSideEnabled    Boolean   @default(true)
  serverSideEnabled    Boolean   @default(false)
  eventMappings        Json?
  migrationStatus      String    @default("not_started")
  migratedAt           DateTime?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  clientConfig         Json?
  credentialsEncrypted String?
  credentials_legacy   Json?
  configVersion        Int       @default(1)
  environment          String    @default("live")
  previousConfig       Json?
  rollbackAllowed      Boolean   @default(true)
  displayName          String?
  priority             Int?      @default(0)
  Shop                 Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, platform, environment, platformId])
  @@index([environment])
  @@index([platform])
  @@index([priority])
  @@index([shopId])
  @@index([shopId, platform])
}

model PixelEventReceipt {
  id                String           @id
  shopId            String
  eventId           String
  eventType         String
  platform          String           @default("unknown")
  environment       String           @default("live")
  pixelTimestamp    DateTime
  verificationRunId String?
  originHost        String?
  payloadJson       Json?
  checkoutFingerprint String?
  orderKey          String?
  altOrderKey       String?
  hmacMatched       Boolean          @default(false)
  trustLevel        String           @default("untrusted")
  totalValue        Decimal?         @db.Decimal(12, 2)
  currency          String?
  createdAt         DateTime         @default(now())
  Shop              Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  VerificationRun   VerificationRun? @relation(fields: [verificationRunId], references: [id], onDelete: SetNull)

  @@unique([shopId, eventId, eventType, platform])
  @@index([shopId])
  @@index([shopId, pixelTimestamp])
  @@index([verificationRunId])
  @@index([eventType])
  @@index([shopId, eventType, pixelTimestamp])
  @@index([orderKey])
  @@index([altOrderKey])
  @@index([eventId])
  @@index([platform])
  @@index([shopId, createdAt, hmacMatched])
  @@index([environment])
}

model VerificationRun {
  id                  String              @id
  shopId              String
  runName             String              @default("验收测试")
  runType             String              @default("quick")
  status              String              @default("pending")
  platforms           String[]
  summaryJson         Json?
  eventsJson          Json?
  reportUrl           String?
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime            @default(now())
  Shop                Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  PixelEventReceipt   PixelEventReceipt[]
  ReportShareLink     ReportShareLink[]

  @@index([createdAt])
  @@index([shopId, createdAt])
  @@index([shopId])
  @@index([shopId, status, createdAt])
  @@index([shopId, status])
  @@index([status])
}

model ReportShareLink {
  id            String          @id
  shopId         String
  runId          String
  tokenHash      String          @unique
  tokenPrefix    String
  scope          String          @default("verification_report")
  expiresAt      DateTime
  revokedAt      DateTime?
  createdBy      String?
  accessCount    Int             @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  Shop           Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  VerificationRun VerificationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([shopId, runId])
  @@index([runId, revokedAt, expiresAt])
  @@index([expiresAt])
}

model EventLog {
  id                  String            @id
  shopId              String
  source              String            @default("web_pixel")
  eventName           String
  eventId             String
  occurredAt          DateTime
  shopifyContextJson  Json?
  normalizedEventJson Json
  createdAt           DateTime          @default(now())
  Shop                Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, eventId])
  @@index([shopId])
  @@index([shopId, createdAt])
  @@index([shopId, eventName, createdAt])
  @@index([eventId])
  @@index([occurredAt])
}

model WebhookLog {
  id          String    @id
  shopDomain  String
  webhookId   String
  topic       String
  status      String    @default("processing")
  orderId     String?
  receivedAt  DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  @@unique([shopDomain, webhookId, topic])
  @@index([shopDomain])
  @@index([receivedAt])
  @@index([receivedAt, status])
}

model MonthlyUsage {
  id        String   @id
  shopId    String
  yearMonth String
  sentCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, yearMonth])
  @@index([shopId])
  @@index([yearMonth])
}

model MigrationDraft {
  id         String   @id
  shopId     String   @unique
  step       String
  configData Json
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([shopId, updatedAt])
}

model GDPRJob {
  id           String    @id
  shopDomain   String
  jobType      String
  payload      Json
  status       String    @default("queued")
  result       Json?
  errorMessage String?
  createdAt    DateTime  @default(now())
  processedAt  DateTime?
  completedAt  DateTime?

  @@index([status])
  @@index([shopDomain])
  @@index([createdAt])
}

model AuditLog {
  id            String   @id
  shopId        String
  actorType     String
  actorId       String?
  action        String
  resourceType  String
  resourceId    String?
  previousValue Json?
  newValue      Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  Shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@index([shopId, createdAt])
}

model InternalEvent {
  id               String    @id
  shopId            String
  source           String
  event_name       String
  event_id         String
  client_id        String?
  timestamp        BigInt
  occurred_at      DateTime
  ip               String?
  ip_encrypted     String?
  user_agent       String?
  user_agent_encrypted String?
  page_url         String?
  referrer         String?
  querystring      String?
  currency         String?
  value            Decimal   @db.Decimal(12, 2)
  transaction_id   String?
  items            Json?
  user_data_hashed Json?
  consent_purposes Json?
  environment      String    @default("live")
  createdAt        DateTime  @default(now())
  Shop             Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  EventDispatchJob EventDispatchJob[]

  @@unique([shopId, event_id, event_name])
  @@index([shopId])
  @@index([shopId, occurred_at])
  @@index([shopId, source])
}

model EventDispatchJob {
  id                String        @id
  internal_event_id String
  destination       String
  status            String
  attempts          Int           @default(0)
  next_retry_at     DateTime
  last_error        String?
  last_response_code Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  InternalEvent     InternalEvent @relation(fields: [internal_event_id], references: [id], onDelete: Cascade)

  @@unique([internal_event_id, destination])
  @@index([status, next_retry_at])
}


model BatchAuditJob {
  id          String   @id
  shopId      String
  requesterId String
  status      String   @default("pending")
  progress    Int      @default(0)
  result      Json?
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([status])
  @@index([createdAt])
}
