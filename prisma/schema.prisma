// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Shopify Session storage for OAuth
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

// Shop information and subscription status
model Shop {
  id                String               @id @default(cuid())
  shopDomain        String               @unique
  accessToken       String?
  email             String?
  name              String?
  plan              String               @default("free") // free, starter, pro, enterprise
  monthlyOrderLimit Int                  @default(100)
  installedAt       DateTime             @default(now())
  uninstalledAt     DateTime?
  isActive          Boolean              @default(true)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  scanReports            ScanReport[]
  pixelConfigs           PixelConfig[]
  alertConfigs           AlertConfig[]
  conversionLogs         ConversionLog[]
  reconciliationReports  ReconciliationReport[]
  surveyResponses        SurveyResponse[]
}

// Scan report for tracking scripts
model ScanReport {
  id                String   @id @default(cuid())
  shopId            String
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  // Scan results
  additionalScripts Json?    // Raw additional scripts content
  scriptTags        Json?    // ScriptTag API results
  checkoutConfig    Json?    // Checkout configuration
  
  // Risk analysis
  riskItems         Json?    // Array of identified risks
  riskScore         Int      @default(0) // 0-100 risk score
  
  // Identified platforms
  identifiedPlatforms Json?  // e.g., ["google", "meta", "tiktok"]
  
  status            String   @default("pending") // pending, scanning, completed, failed
  errorMessage      String?
  
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  
  @@index([shopId])
  @@index([status])
}

// Pixel configuration for each platform
model PixelConfig {
  id                String   @id @default(cuid())
  shopId            String
  shop              Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  platform          String   // google, meta, tiktok, bing, clarity
  platformId        String?  // e.g., GA4 Measurement ID, Meta Pixel ID
  
  // Platform-specific credentials
  credentials       Json?    // Encrypted credentials for server-side API
  
  // Configuration
  clientSideEnabled   Boolean @default(true)
  serverSideEnabled   Boolean @default(false)
  eventMappings       Json?   // Custom event mappings
  
  // Migration status
  migrationStatus     String  @default("not_started") // not_started, in_progress, completed
  migratedAt          DateTime?
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([shopId, platform])
  @@index([shopId])
  @@index([platform])
}

// Alert configuration for monitoring
model AlertConfig {
  id              String   @id @default(cuid())
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  channel         String   // email, slack, telegram
  settings        Json     // Channel-specific settings (email address, webhook URL, etc.)
  
  // Alert thresholds
  discrepancyThreshold Float @default(0.1) // 10% default threshold
  minOrdersForAlert    Int   @default(10)  // Minimum orders before alerting
  
  // Alert frequency
  frequency       String   @default("daily") // daily, weekly, instant
  
  isEnabled       Boolean  @default(true)
  lastAlertAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([shopId])
  @@index([channel])
}

// Conversion tracking log
model ConversionLog {
  id              String   @id @default(cuid())
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  // Order info
  orderId         String
  orderNumber     String?
  orderValue      Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  
  // Platform info
  platform        String   // google, meta, tiktok
  eventType       String   // purchase, add_to_cart, etc.
  
  // Sending status
  status          String   @default("pending") // pending, sent, failed, retrying
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  errorMessage    String?
  
  // Response from platform
  platformResponse Json?
  
  // Metadata
  clientSideSent    Boolean @default(false)
  serverSideSent    Boolean @default(false)
  
  createdAt       DateTime @default(now())
  sentAt          DateTime?
  
  @@unique([shopId, orderId, platform, eventType])
  @@index([shopId])
  @@index([orderId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
}

// Daily reconciliation reports
model ReconciliationReport {
  id                  String   @id @default(cuid())
  shopId              String
  shop                Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  platform            String   // google, meta, tiktok
  reportDate          DateTime @db.Date
  
  // Shopify data
  shopifyOrders       Int      @default(0)
  shopifyRevenue      Decimal  @db.Decimal(12, 2) @default(0)
  
  // Platform reported data
  platformConversions Int      @default(0)
  platformRevenue     Decimal  @db.Decimal(12, 2) @default(0)
  
  // Calculated metrics
  orderDiscrepancy    Float    @default(0) // Percentage difference
  revenueDiscrepancy  Float    @default(0)
  
  // Status
  status              String   @default("pending") // pending, completed, failed
  alertSent           Boolean  @default(false)
  
  createdAt           DateTime @default(now())
  
  @@unique([shopId, platform, reportDate])
  @@index([shopId])
  @@index([platform])
  @@index([reportDate])
}

// Post-purchase survey responses
model SurveyResponse {
  id              String   @id @default(cuid())
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  orderId         String
  orderNumber     String?
  
  // Survey data
  rating          Int?     // 1-5 star rating
  feedback        String?  // Open text feedback
  source          String?  // How did you hear about us?
  customAnswers   Json?    // Custom survey question answers
  
  createdAt       DateTime @default(now())
  
  @@index([shopId])
  @@index([orderId])
}

