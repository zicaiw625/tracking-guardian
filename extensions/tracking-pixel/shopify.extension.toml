# Learn more: https://shopify.dev/docs/apps/build/online-store/web-pixels

# P0-1: Updated from 2024-10 to 2025-07 (2024-10 no longer supported as of 2025-10-01)
api_version = "2025-07"
type = "web_pixel_extension"
name = "Tracking Guardian Pixel"
runtime_context = "strict"

# Privacy & Consent Configuration (P0-03)
# 
# DESIGN PRINCIPLE: Declare accurately what the pixel does
# ============================================================================
# 
# This pixel sends checkout_completed events to our backend, which then
# forwards conversion data to advertising platforms (Meta CAPI, TikTok Events API, etc.)
# This constitutes both analytics AND marketing use, as well as data sharing.
#
# CONSENT REQUIREMENTS:
# - analytics=true: Required for conversion measurement functionality
# - marketing=true: Required because we send data to ad platforms for attribution
# - sale_of_data="enabled": We share conversion data with third parties (ad platforms)
#
# HOW IT WORKS:
# 1. Shopify only loads this pixel when BOTH analytics AND marketing consent are granted
# 2. Our code additionally checks saleOfDataAllowed before sending any data
# 3. If customer opts out of any: no data is sent to backend or ad platforms
#
# This is the most compliant configuration for App Store review, ensuring:
# - Privacy disclosure in Partner Dashboard matches actual behavior
# - Customers must explicitly consent to marketing before any data is shared
# - CCPA sale_of_data opt-out is respected
#
[customer_privacy]
  # Analytics: required for conversion tracking measurement
  analytics = true
  # Marketing: required because we share data with ad platforms (Meta, TikTok, etc.)
  # This ensures pixel only loads when user explicitly consents to marketing
  marketing = true
  # Preferences: not used by this pixel
  preferences = false
  # Sale of data: enabled - we share conversion data with third-party ad platforms
  # When user opts out (CCPA), our code respects that and doesn't send data
  sale_of_data = "enabled"

# P0-01: Backend URL is hardcoded in the pixel extension for security
# This prevents merchants from configuring arbitrary data exfiltration endpoints
# The production URL is set as a constant in the extension source code

[settings]
  # Ingestion Key - store-scoped key for request correlation and noise filtering
  # 
  # SECURITY CLARIFICATION (P1-2):
  # - This is a WEAK validation mechanism, NOT a security boundary
  # - The key is visible in browser network traffic (not truly secret)
  # - Primary purpose: correlate pixel events with webhooks, filter noise/misconfiguration
  # - Defense layers are server-side: Origin validation, rate limiting, order ownership
  #
  # Server behavior:
  # - Missing/invalid key: request rejected (204 No Content)
  # - Valid key: request processed (correlated with shop for diagnostics)
  [[settings.fields]]
    key = "ingestion_secret"
    name = "Ingestion Key"
    description = "Store-scoped key for event correlation. Validated by server for noise filtering (not a security credential)."
    type = "single_line_text_field"
  
  # Note: debug field removed - Shopify settings are always strings (single_line_text_field)
  # and parsing boolean strings correctly across create/update/read cycles is error-prone.
  # For debugging, developers can use browser DevTools to inspect network requests.
