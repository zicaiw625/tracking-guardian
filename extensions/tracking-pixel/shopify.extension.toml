# IMPORTANT: The 'uid' field below MUST be generated by Shopify CLI.
# Run: shopify app deploy
# The CLI will auto-generate and fill in the uid on first deployment.
# DO NOT manually create a fake uid - it will cause webPixelCreate to fail.
#
# If uid is missing after deploy, run: shopify app generate extension --type web_pixel
# and copy the generated uid here, or check .shopify/project.json

api_version = "2025-07"
type = "web_pixel_extension"
name = "Tracking Guardian Pixel"
handle = "tracking-guardian-pixel"
runtime_context = "strict"

# Customer Privacy settings determine when this pixel loads.
# The pixel will ONLY load when ALL required consents are granted.
#
# P0-4: 改进配置（更高覆盖率 + 服务端分层判断）
# - analytics = true: Pixel 需要 analytics consent 才能加载
# - marketing = false: Pixel 不强制要求 marketing consent（覆盖率更高）
# - sale_of_data = "enabled": Pixel 尊重 CCPA 选择
#
# 配置说明：
# 这个配置允许 Pixel 在只有 analytics 同意时也能加载和发送事件。
# 服务端（route.tsx / consent-filter.ts）会根据各平台的 requiresSaleOfData 和
# marketing/analytics 配置，逐平台判断是否发送 CAPI。
# - GA4 (requiresSaleOfData=false): 只需 analytics 同意
# - Meta/TikTok (requiresSaleOfData=true): 需要 marketing + saleOfData 同意
#
# 预期效果：
# - 覆盖率提高（analytics 同意的用户也能被追踪）
# - 合规性保持（marketing 平台仍受服务端严格检查）
#
# Reference: https://shopify.dev/docs/api/web-pixels-api/pixel-privacy
[customer_privacy]
analytics = true
marketing = false
preferences = false
sale_of_data = "enabled"

# Settings schema - MUST use type = "object" per Shopify Web Pixel requirements.
# All field types MUST be "single_line_text_field" (only type supported).
# Reference: https://shopify.dev/docs/apps/build/marketing-analytics/build-web-pixels
#
# P0-6: Settings schema 与 buildWebPixelSettings() 严格对齐
# P1-5: 扩展配置支持 JSON 格式的 pixel_config
# backend_url 是构建时常量，不作为运行时配置
[settings]
type = "object"

[settings.fields.ingestion_key]
name = "Ingestion Key"
description = "Store-scoped key for event correlation. Auto-generated during app installation."
type = "single_line_text_field"

[settings.fields.shop_domain]
name = "Shop Domain"
description = "The myshopify.com domain for this store. Auto-configured during installation."
type = "single_line_text_field"

[settings.fields.pixel_config]
name = "Pixel Configuration"
description = "JSON configuration for pixel behavior (mode, strictness, enabled platforms). Schema versioned for compatibility."
type = "single_line_text_field"
