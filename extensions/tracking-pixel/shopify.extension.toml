# Learn more: https://shopify.dev/docs/apps/build/online-store/web-pixels

# P0-1: Updated from 2024-10 to 2025-07 (2024-10 no longer supported as of 2025-10-01)
api_version = "2025-07"
type = "web_pixel_extension"
name = "Tracking Guardian Pixel"
runtime_context = "strict"

# Privacy & Consent Configuration (P3)
# 
# DESIGN PRINCIPLE: Lower the pixel loading threshold, control sending in code
# ============================================================================
# 
# Problem with requiring BOTH analytics=true AND marketing=true:
#   - Shopify may only load the pixel when BOTH consents are granted
#   - This significantly reduces pixel load coverage
#   - Our code-level consent checking becomes useless if pixel never loads
#
# Solution: Only require analytics consent for pixel loading
#   - analytics=true: Pixel loads when user consents to analytics
#   - marketing=false: Don't require marketing consent to LOAD the pixel
#   - sale_of_data="enabled": Respect user opt-out for data sharing
#
# Code-level consent checking (in index.ts):
#   - hasAnyConsent() checks: (marketing OR analytics) AND saleOfDataAllowed
#   - If user only consented to analytics but not marketing: we can still load
#   - If user opted out of sale_of_data: we DON'T send to ad platforms
#
# This gives us maximum flexibility while respecting user consent choices
#
[customer_privacy]
  # Analytics: pixel loads when analytics consent is granted
  # Conversion tracking is fundamentally an analytics/measurement function
  analytics = true
  # Marketing: NOT required for pixel loading
  # Our code checks marketing consent before sending to ad platforms
  # Setting to false allows pixel to load even without marketing consent
  marketing = false
  # Preferences: not used by this pixel
  preferences = false
  # Sale of data: enabled - we share conversion data with ad platforms
  # When user opts out, our code respects that and doesn't send data
  sale_of_data = "enabled"

# P0-01: Backend URL is hardcoded in the pixel extension for security
# This prevents merchants from configuring arbitrary data exfiltration endpoints
# The production URL is set as a constant in the extension source code

[settings]
  # Ingestion Key - store-scoped key for request correlation and noise filtering
  # 
  # SECURITY CLARIFICATION (P1-2):
  # - This is a WEAK validation mechanism, NOT a security boundary
  # - The key is visible in browser network traffic (not truly secret)
  # - Primary purpose: correlate pixel events with webhooks, filter noise/misconfiguration
  # - Defense layers are server-side: Origin validation, rate limiting, order ownership
  #
  # Server behavior:
  # - Missing/invalid key: request rejected (204 No Content)
  # - Valid key: request processed (correlated with shop for diagnostics)
  [[settings.fields]]
    key = "ingestion_secret"
    name = "Ingestion Key"
    description = "Store-scoped key for event correlation. Validated by server for noise filtering (not a security credential)."
    type = "single_line_text_field"
  
  # Note: debug field removed - Shopify settings are always strings (single_line_text_field)
  # and parsing boolean strings correctly across create/update/read cycles is error-prone.
  # For debugging, developers can use browser DevTools to inspect network requests.
