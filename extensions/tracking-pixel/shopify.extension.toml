# Learn more: https://shopify.dev/docs/apps/build/online-store/web-pixels

api_version = "2024-10"
type = "web_pixel_extension"
name = "Tracking Guardian Pixel"
runtime_context = "strict"

# Privacy & Consent Configuration (P3)
# 
# DESIGN PRINCIPLE: Lower the pixel loading threshold, control sending in code
# ============================================================================
# 
# Problem with requiring BOTH analytics=true AND marketing=true:
#   - Shopify may only load the pixel when BOTH consents are granted
#   - This significantly reduces pixel load coverage
#   - Our code-level consent checking becomes useless if pixel never loads
#
# Solution: Only require analytics consent for pixel loading
#   - analytics=true: Pixel loads when user consents to analytics
#   - marketing=false: Don't require marketing consent to LOAD the pixel
#   - sale_of_data="enabled": Respect user opt-out for data sharing
#
# Code-level consent checking (in index.ts):
#   - hasAnyConsent() checks: (marketing OR analytics) AND saleOfDataAllowed
#   - If user only consented to analytics but not marketing: we can still load
#   - If user opted out of sale_of_data: we DON'T send to ad platforms
#
# This gives us maximum flexibility while respecting user consent choices
#
[customer_privacy]
  # Analytics: pixel loads when analytics consent is granted
  # Conversion tracking is fundamentally an analytics/measurement function
  analytics = true
  # Marketing: NOT required for pixel loading
  # Our code checks marketing consent before sending to ad platforms
  # Setting to false allows pixel to load even without marketing consent
  marketing = false
  # Preferences: not used by this pixel
  preferences = false
  # Sale of data: enabled - we share conversion data with ad platforms
  # When user opts out, our code respects that and doesn't send data
  sale_of_data = "enabled"

# P0-01: Backend URL is hardcoded in the pixel extension for security
# This prevents merchants from configuring arbitrary data exfiltration endpoints
# The production URL is set as a constant in the extension source code

[settings]
  # P0-03: Ingestion Key - used for request association and diagnostics (NOT a security credential)
  # This is NOT a cryptographic secret - it's used for:
  # - Correlating pixel events with webhook events
  # - Filtering noise from invalid requests
  # - Diagnostics and troubleshooting
  [[settings.fields]]
    key = "ingestion_secret"
    name = "Ingestion Key"
    description = "Key for request association and diagnostics (auto-generated). NOT used for security - the security boundary is server-side validation."
    type = "single_line_text_field"
  
  # Note: debug field removed - Shopify settings are always strings (single_line_text_field)
  # and parsing boolean strings correctly across create/update/read cycles is error-prone.
  # For debugging, developers can use browser DevTools to inspect network requests.
