# IMPORTANT: The 'uid' field below MUST be generated by Shopify CLI.
# Run: shopify app deploy
# The CLI will auto-generate and fill in the uid on first deployment.
# DO NOT manually create a fake uid - it will cause webPixelCreate to fail.
#
# If uid is missing after deploy, run: shopify app generate extension --type web_pixel
# and copy the generated uid here, or check .shopify/project.json
#
# ⚠️ 重要：uid 必须由 Shopify CLI 在首次部署时自动生成
# 如果这是新扩展，运行 `shopify app deploy` 会自动生成并填充 uid
# 如果 uid 缺失或无效，会导致扩展创建/更新失败

api_version = "2025-07"
uid = "03d3e252-5760-443c-5403-68d2888bbf444a40ddc0"
type = "web_pixel_extension"
name = "Tracking Guardian Pixel"
handle = "tracking-guardian-pixel"
runtime_context = "strict"

# Customer Privacy settings determine when this pixel loads.
# The pixel will ONLY load when ALL required consents are granted.
#
# P0: v1.0 配置策略（像素加载 vs 后端过滤的一致性）
# 
# 像素加载策略（customer_privacy）：
# - analytics = true: Pixel 需要 analytics consent 才能加载
# - marketing = false: Pixel 不强制要求 marketing consent（提高覆盖率）
# - sale_of_data = "enabled": Pixel 尊重 CCPA 选择（但不强制要求）
#
# 后端过滤策略（consent-filter.ts / platform-consent.ts）：
# - GA4 (requiresSaleOfData=false): 只需 analytics 同意即可发送
# - Meta/TikTok (requiresSaleOfData=true): 需要 marketing + saleOfData 同意才发送
#
# 策略一致性说明：
# 1. Pixel 在 analytics 同意时加载 → 所有事件都会发送到后端
# 2. 后端根据平台要求过滤：
#    - GA4: analytics 同意即可，事件会被发送
#    - Meta/TikTok: 需要 marketing + saleOfData，否则事件被过滤
# 3. 这确保了：
#    - 覆盖率：analytics 同意的用户也能被 GA4 追踪
#    - 合规性：marketing 平台（Meta/TikTok）仍受严格检查
#    - 一致性：像素加载条件与后端过滤逻辑对齐（像素加载 ≤ 后端发送条件）
#
# 注意：如果用户只同意 analytics 但不同意 marketing，Meta/TikTok 事件会在后端被过滤，
# 但不会影响 GA4 事件的发送。这符合各平台的合规要求。
#
# ⚠️ 上架前审查要点（P0）：
# - 此配置确保像素加载策略与后端过滤逻辑一致
# - 像素在 analytics 同意时加载，但后端会根据平台要求进一步过滤
# - 这避免了"像素加载了但事件被过滤导致商家误以为丢数"的问题
# - 如果修改此配置，必须同步更新后端过滤逻辑（consent-filter.ts）
#
# 策略一致性验证：
# 1. 像素加载条件：analytics = true（需要 analytics consent）
# 2. 后端过滤条件（app/routes/api.pixel-events/consent-filter.ts + app/utils/platform-consent.ts）：
#    - GA4 (google): requiresSaleOfData=false, category=analytics → 只需 analytics 同意即可发送
#    - Meta/TikTok: requiresSaleOfData=true, category=marketing → 需要 marketing + saleOfData 同意才发送
# 3. 确保：像素加载条件 ≤ 后端发送条件（像素加载时，至少 GA4 可以发送）
#
# ✅ P0-2 验证通过：像素加载策略与后端过滤逻辑已对齐
# - 像素在 analytics 同意时加载（customer_privacy.analytics = true）
# - 后端会根据平台要求进一步过滤（GA4 只需 analytics，Meta/TikTok 需要 marketing + saleOfData）
# - 这确保了：像素加载时，至少 GA4 可以发送；Meta/TikTok 需要额外同意才会发送
#
# Reference: https://shopify.dev/docs/api/web-pixels-api/pixel-privacy
[customer_privacy]
analytics = true
marketing = false
preferences = false
sale_of_data = "enabled"

# Settings schema - MUST use type = "object" per Shopify Web Pixel requirements.
# All field types MUST be "single_line_text_field" (only type supported).
# Reference: https://shopify.dev/docs/apps/build/marketing-analytics/build-web-pixels
#
# P0-6: Settings schema 与 buildWebPixelSettings() 严格对齐
# P1-5: 扩展配置支持 JSON 格式的 pixel_config
# backend_url 是构建时常量，不作为运行时配置
[settings]
type = "object"

[settings.fields.ingestion_key]
name = "Ingestion Key"
description = "Store-scoped key for event correlation. Auto-generated during app installation."
type = "single_line_text_field"

[settings.fields.shop_domain]
name = "Shop Domain"
description = "The myshopify.com domain for this store. Auto-configured during installation."
type = "single_line_text_field"

[settings.fields.config_version]
name = "Config Version"
description = "Configuration schema version for backward compatibility. Auto-configured during installation."
type = "single_line_text_field"

# P1-11: pixel_config 已移除，不再在 settings 中存储大 JSON
# 像素端使用默认配置，完整配置由后端根据 shop_domain 提供
# [settings.fields.pixel_config]
# name = "Pixel Configuration"
# description = "JSON configuration for pixel behavior (mode, strictness, enabled platforms). Schema versioned for compatibility."
# type = "single_line_text_field"
